#! /bin/sh

# Use browser network inspect to find URL of index.m3u8 file, or of one of the segment .ts files

URL=${1?Missing URL}
OFP=${2?Missing output filename}

BASE_URL=${URL%/*}

echo $URL
echo $BASE_URL
echo path $OFP

OFDIR=${OFP%/*}
OFNAME=${OFP##*/}

if [ x$OFDIR = x$OFP ]; then
    OFDIR=.
fi

COFN=$OFDIR/$OFNAME
if [ -e $COFN ]; then
	echo $COFN: exists
	exit 1
fi

mkdir -p $OFDIR

n=1
while true; do
    echo seg-$n
    curl -s -f "$BASE_URL/seg-$n-v1-a1.ts" --output $COFN-seg-$n.ts
    if [ $? -ne 0 ]; then
        break
    fi
    # cat $OFDIR/$OFNAME-seg-$n.ts >> $OFDIR/$OFNAME.ts
    n=$(($n+1))
    sleep 0.5
done

ls -v $COFN-seg-*.ts | xargs cat >> $COFN.ts
ffmpeg -i $COFN.ts -vcodec copy -acodec copy $COFN

rm $COFN-seg-*.ts
rm $COFN.ts
